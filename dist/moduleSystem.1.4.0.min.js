/**
 * moduleSystem
 * Dynamic Loading of Javascript based on DOM elements
 * @version v1.4.0 - 2015-04-21 * @link 
 * @author Eder Alexander <eder.alexan@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */!function(a,b,c){function d(a,b,c){"use strict";var d,e,f=a.querySelector(b);if(null!==f){d=f.innerHTML;try{e=JSON.parse(d)}catch(g){throw new Error("Module ["+c+"] has invalid json in dom. Message: "+g.message)}}return e}function e(a,b){"use strict";var c=!1;return v(a,function(a){return a===b?(c=!0,!0):void 0}),c}function f(a){"use strict";return"[object Array]"===Object.prototype.toString.call(a)}function g(a,b){"use strict";var c=a.indexOf(b);return c>-1?(a.splice(c,1),!0):!1}function h(a,b){"use strict";var c,d,e;for(c in a)if(a.hasOwnProperty(c)&&(d=a[c],e=b(d,c)))break}function i(a){"use strict";return v(arguments,function(b,c){c>0&&h(b,function(b,c){a[c]=b})}),a}function j(a,b){"use strict";return a.indexOf(b)>-1}function k(a){"use strict";if("string"!=typeof a)throw new Error("Name missing");return{name:a}}function l(a){"use strict";var b=k(a);return b.type=y.type.creator,b.settings=c,b.dependencies=[],b.creator=c,b}function m(){"use strict";function a(){g.actualSelector=e(g.selector,"attribute",g.attribute),g.mergeWith=f,g.getModuleSettingsSelector=c,g.getPartSettingsSelector=d}function c(a){return e(g.moduleSettingsSelector,"name",a)}function d(a){return e(g.partSettingsSelector,"name",a)}function e(a,b,c){var d,e="%"+b+"%",f=a;return j(a,e)&&(d=new RegExp(e,"g"),f=a.replace(d,c)),f}function f(b){i(g,b),a()}var g={rootNode:b,defaultScope:y.scope.multiInstance,moduleSettingsSelector:'script[type="%name%/settings"],script[type="true/%name%/settings"]',partSettingsSelector:'head script[type="%name%/settings"]',attribute:"modules",selector:"[%attribute%]",domMutationSupport:!1,customIdAttribute:"mom-id"};return a(),g}function n(a,b,c){"use strict";function d(){var d=c.actualSelector,f=c.rootNode.querySelectorAll(d);b.initEagerSingletons(),v(f,function(a){e(a)}),b.provisionFinished(),a.provisionFinished()}function e(b){a.provisionModule(b)}return{initModulePage:d,initModule:e}}function o(a){"use strict";function b(b){function d(a){if("function"!=typeof a)throw new Error("You have to pass the creator as a reference to a function");i.creator=a,g()}function e(a){if(a!==c&&"object"!=typeof a)throw new Error("You have to pass the settings as an object");return i.settings=a,{dependencies:h,creator:d}}function g(){a.addModuleDescriptor(i)}function h(a){if(a!==c&&!f(a))throw new Error("You have to pass the dependencies as an Array");return i.dependencies=a,{settings:e,creator:d}}var i=l(b);return{settings:e,dependencies:h,creator:d}}return b}function p(a){"use strict";function b(){return a.customIdAttribute}function c(a,b){var c,e=d(a);g.hasOwnProperty(e)?c=g[e]:(c=[],g[e]=c),c.push(b),h.push(b)}function d(a){var c,d=b();return a.hasAttribute(d)?c=a.getAttribute(d):(c=i(),a.setAttribute(d,c)),c}function e(a){var c,d=b();a.hasAttribute(d)&&(c=a.getAttribute(d),g.hasOwnProperty(c)&&delete g[c])}function f(a){var c=b(),d=a.getAttribute(c);return g[d]||[]}var g={},h=[],i=function(){var a=0;return function(){return++a}}();return h.add=c,h.remove=e,h.get=f,h}function q(a,b,f){"use strict";function g(a){q[a.name]=a}function h(a){var b=a.getAttribute(f.attribute),c=b.split(",");v(c,function(b){b=w(b),j(a,b)})}function j(b,c){var d,e;if(!q.hasOwnProperty(c))throw new Error("Module ["+c+"] not created but found in dom");d=q[c],e=a.getParts(d.dependencies),k(b,d,e)}function k(a,e,g){var h,j=g,k=e.name,l=f.getModuleSettingsSelector(k),m=d(a,l,e.name),n={};(e.settings!==c||m!==c)&&(i(n,e.settings,m),j.unshift(n)),j.unshift(a),h=e.creator.apply(e,j),h!==c&&(o.add(a,h),b.add(h))}function l(){v(o,function(a){m(a)})}function m(a){var b=a.postConstruct;"function"==typeof b&&(e(r,b)||(b(),r.push(b)))}function n(a){var c=o.get(a);v(c,function(a){if("function"==typeof a.preDestruct)try{a.preDestruct()}catch(b){f.logger("Exception while calling preDestruct",b)}}),v(c,function(a){b.remove(a)}),o.remove(a)}var o=p(f),q={},r=[];return{provisionModule:h,unloadModules:n,provisionFinished:l,addModuleDescriptor:g}}function r(c,d,e){"use strict";function f(){var b,c=a.WebKitMutationObserver,d=a.MutationObserver;return b=c?n(c):d?n(d):o()}function g(a){if(h(p,a)){var b=k(a,q);x(a,q)&&l(a),v(b,function(a){l(a)}),d.provisionFinished(),e.provisionFinished()}}function h(a,c){return a===b?b.body.contains(c):a.contains(c)}function i(a){var b=k(a,q);v(b,function(a){m(a)}),x(a,q)&&m(a)}function j(a,b){g(a),i(b)}function k(a,b){return a.querySelectorAll?a.querySelectorAll(b):[]}function l(a){return d.provisionModule(a)}function m(a){d.unloadModules(a)}function n(a){function b(){f.observe(p,e)}function c(){f.takeRecords(),f.disconnect()}function d(a,b){v(a,function(a){v(a.addedNodes,function(a){g(a)}),v(a.removedNodes,function(a){i(a)})}),b.takeRecords()}var e={attributes:!0,childList:!0,characterData:!0,subtree:!0},f=new a(d);return{register:b,unregister:c}}function o(){function a(){!function(a){Element.prototype.appendChild=function(b,c){var d=a.apply(this,[b,c]);return g(b),d}}(Element.prototype.appendChild),function(a){Element.prototype.insertBefore=function(b,c){var d=a.apply(this,[b,c]);return g(b),d}}(Element.prototype.insertBefore),function(a){Element.prototype.removeChild=function(b,c){var d=a.apply(this,[b,c]);return i(b),d}}(Element.prototype.removeChild),function(a){Element.prototype.replaceChild=function(b,c){var d=a.apply(this,[b,c]);return j(b,c),d}}(Element.prototype.replaceChild)}function b(){!function(a){Element.prototype.appendChild=function(b,c){return a.apply(this,[b,c])}}(c),function(a){Element.prototype.insertBefore=function(b,c){return a.apply(this,[b,c])}}(d),function(a){Element.prototype.removeChild=function(b,c){return a.apply(this,[b,c])}}(e),function(a){Element.prototype.replaceChild=function(b,c){return a.apply(this,[b,c])}}(f)}var c=Element.prototype.appendChild,d=Element.prototype.insertBefore,e=Element.prototype.removeChild,f=Element.prototype.replaceChild;return{register:a,unregister:b}}var p=c.rootNode,q=c.actualSelector,r=f();return{registerToEvents:r.register,unregisterToEvents:r.unregister}}function s(a,b){"use strict";function d(a){var b=k(a);return b.type=y.type.returns,b.scope=i,b.returns=c,b}function e(a){var c=l(a);return c.scope=b.defaultScope,c}function g(b){function g(a){if("function"!=typeof a)throw new Error("You have to pass the creator as a reference to a function");o().creator=a,p()}function h(a){if(a===c)throw new Error("You have to pass the returns as one of these object types: string|integer|float|boolean|object|function|Array");q=d(b),q.returns=a,p()}function k(a){if(i!==a&&j!==a&&m!==a)throw new Error("You have to pass the scope as one of these: lazy-singleton|eager-singleton|multi-instance");var b=o();return a!==c&&(b.scope=a),{settings:l,dependencies:n,creator:g,returns:h}}function l(a){if(a!==c&&"object"!=typeof a)throw new Error("You have to pass the settings as an object");return o().settings=a,{dependencies:n,creator:g,scope:k}}function n(a){if(a!==c&&!f(a))throw new Error("You have to pass the dependencies as an Array");return o().dependencies=a,{settings:l,creator:g,scope:k}}function o(){return q===c&&(q=e(b)),q}function p(){a.addPartDescriptor(q)}var q;return{settings:l,dependencies:n,creator:g,returns:h,scope:k}}var h=y.scope,i=h.lazySingleton,j=h.eagerSingleton,m=h.multiInstance;return g}function t(a){"use strict";function f(a){B[a.name]=a}function g(){var a=[];h(B,function(b,c){b.scope===y.scope.eagerSingleton&&a.push(c)}),j(a)}function j(a){var b=[];return v(a,function(a){var c=k(a);b.push(c)}),b}function k(a){var b,c,d;if(!B.hasOwnProperty(a))throw new Error("tried to load "+a+" but was not registered");return l(a),b=B[a],c=n(b.scope),d=c(b),m(a),d}function l(a){var b=!0;if(A.hasOwnProperty(a))throw new Error("Circular dependency detected for part ["+a+"]");A[a]=b}function m(a){delete A[a]}function n(a){switch(a){case y.scope.multiInstance:return o;case y.scope.lazySingleton:case y.scope.eagerSingleton:return p;default:throw new Error("unknown scope ["+a+"]")}}function o(a){var b,c=q(a.type);return b=c(a),z.push(b),b}function p(a){var b=a.name,d=x[b];return d===c&&(d=o(a),x[b]=d),d}function q(a){switch(a){case y.type.returns:return r;case y.type.creator:return s;default:throw new Error("unknown type ["+a+"]")}}function r(a){return a.returns}function s(e){var f,g,h,k,l=e.name,m=a.getPartSettingsSelector(l),n=d(b,m,e.name),o={};return f=e.dependencies,g=j(f),h=g,(e.settings!==c||n!==c)&&(i(o,e.settings,n),h.unshift(o)),k=e.creator.apply(e,h),k===c&&(k={}),k}function t(){h(z,function(a){u(a)})}function u(a){var b=a.postConstruct;"function"==typeof b&&(e(C,b)||(b(),C.push(b)))}function w(a){var b=k(a);return u(b),b}var x={},z=[],A={},B={},C=[];return{initEagerSingletons:g,provisionPart:w,getParts:j,provisionFinished:t,addPartDescriptor:f}}function u(){"use strict";function a(a){if(a===c)throw new Error("Published event cannot be undefined");var d="on"+a.name;v(j,function(e){a.name!==c&&b(e,d,a),b(e,i,a)})}function b(a,b,c){var d=a[b];"function"==typeof d&&d.call(a,c)}function d(a){if(a===c)throw new Error("Listener to be registered is undefined");if(e(j,a))throw new Error("Listener is already registered");j.push(a)}function f(a){if(a===c)throw new Error("Listener to be removed is undefined");var b=g(j,a);if(!b)throw new Error("Listener to be removed is not registered")}function h(){j=[]}var i="onEvent",j=[];return{publish:a,add:d,remove:f,reset:h}}var v=function(){"use strict";function a(a,b){Array.prototype.forEach.call(a,b)}function b(a,b){var c,d,e,f=a.length;for(c=0;f>c&&(d=a[c],!(e=b(d,c,a)));c++);}return Array.prototype.forEach?a:b}(),w=function(){"use strict";function a(a){return a.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}function b(a){return String.prototype.trim.call(a)}return String.prototype.trim?b:a}(),x=function(){"use strict";function a(a,b){return d.call(a,b)}function b(a,b){for(var c=a.parentNode||a.document,d=c.querySelectorAll(b),e=-1;d[++e]&&d[e]!==a;);return!!d[e]}var c=Element.prototype,d=c.matches||c.matchesSelector||c.mozMatchesSelector||c.msMatchesSelector||c.oMatchesSelector||c.webkitMatchesSelector;return d?a:b}(),y={scope:{lazySingleton:"lazy-singleton",eagerSingleton:"eager-singleton",multiInstance:"multi-instance"},type:{returns:"returns",creator:"creator"}};moduleSystem=function(){"use strict";function b(){function d(a){a!==c&&g.mergeWith(a),v.initModulePage(),f=r(g,k,h),g.domMutationSupport===!0&&f.registerToEvents()}function e(){f!==c&&f.unregisterToEvents(),j.reset()}var f,g=m(),h=t(g),j=u(),k=q(h,j,g),l=s(h,g),p=o(k),v=n(k,h,g);return l("event-bus").returns(j),l("eventBus").creator(function(){return a.console&&console.warn&&console.warn('partName "eventBus" deprecated use "event-bus" instead'),j}),i({createPart:l,createModule:p,initModulePage:d,newInstance:b,dispose:e,getPart:h.provisionPart},y)}return b()}()}(window,document);